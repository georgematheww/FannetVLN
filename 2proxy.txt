#========================
# Global settings
#========================
global
    log /dev/log local0
    maxconn 4096
    user haproxy
    group haproxy
    daemon

#========================
# Default settings
#========================
defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s

#========================
# Frontend: WAF entry point
#========================
frontend http-in
    bind 10.255.40.21:80

    # Track per-IP connection and request rates
    stick-table type ip size 1m expire 30s store conn_rate(30s),http_req_rate(10s)

    # Track source IPs
    tcp-request connection track-sc0 src
    http-request track-sc0 src

    # SYN flood protection: reject if >50 new connections in 30s
    tcp-request connection reject if { sc0_conn_rate gt 50 }

    # HTTP flood protection: deny if >100 requests in 10s
    http-request deny if { sc0_http_req_rate gt 100 }

    # Whitelist management subnet (never blocked)
    acl mgmt_net src 10.255.200.0/24
    tcp-request connection accept if mgmt_net
    http-request allow if mgmt_net

    # Forward real client IP to backend
    option forwardfor

    default_backend web-backend

#========================
# Backend: XAMPP server
#========================
backend web-backend
    server web1 10.255.40.10:80 check
